# GitLab CI/CD Pipeline for RCV Lunch Picker
#
# Required CI/CD Variables (Settings > CI/CD > Variables):
#   DEPLOY_HOST       - SSH host for deployment (e.g., your-droplet.example.com)
#   DEPLOY_USER       - SSH user on the server (e.g., deploy)
#   DEPLOY_SSH_KEY    - Private SSH key for authentication (type: File, protected)
#   DEPLOY_PATH       - Path to app on server (e.g., /var/www/rcv-lunch)
#
# Optional Variables:
#   DEPLOY_PORT       - SSH port (default: 22)
#   PM2_PROCESS_NAME  - pm2 process name (default: rcv-lunch)

stages:
  - validate
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  PM2_PROCESS_NAME: "rcv-lunch"

# Cache node_modules between jobs
.node_cache: &node_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull-push

# Base job for Node.js
.node_base:
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  before_script:
    - npm ci --prefer-offline

# =============================================================================
# VALIDATE STAGE
# =============================================================================

lint:
  stage: validate
  extends: .node_base
  script:
    - npm run lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^claude\//

typecheck:
  stage: validate
  extends: .node_base
  script:
    - npx tsc --noEmit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^claude\//

# =============================================================================
# TEST STAGE
# =============================================================================

test:
  stage: test
  extends: .node_base
  script:
    - npm test -- --coverage --ci
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^claude\//

# =============================================================================
# BUILD STAGE
# =============================================================================

build:
  stage: build
  extends: .node_base
  script:
    - npm run build
  artifacts:
    paths:
      - .next/
      - public/
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^claude\//

# =============================================================================
# DEPLOY STAGE
# =============================================================================

# Deploy to production (manual trigger on main branch)
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - chmod 600 "$DEPLOY_SSH_KEY"
    - ssh-add "$DEPLOY_SSH_KEY"
    - mkdir -p ~/.ssh
    - ssh-keyscan -p ${DEPLOY_PORT:-22} $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - |
      echo "=========================================="
      echo "Deploying to production..."
      echo "Host: $DEPLOY_HOST"
      echo "Path: $DEPLOY_PATH"
      echo "=========================================="

    # Sync files to server (excluding node_modules, .git, data)
    - |
      rsync -avz --delete \
        --exclude 'node_modules' \
        --exclude '.git' \
        --exclude 'data' \
        --exclude '.env' \
        --exclude 'coverage' \
        -e "ssh -p ${DEPLOY_PORT:-22}" \
        ./ ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/

    # Install dependencies and restart on server
    - |
      ssh -p ${DEPLOY_PORT:-22} ${DEPLOY_USER}@${DEPLOY_HOST} << EOF
        cd ${DEPLOY_PATH}
        npm ci --production
        npm run build
        pm2 reload ${PM2_PROCESS_NAME} || pm2 start deploy/pm2/ecosystem.config.cjs
        pm2 save
      EOF

    - echo "Deployment complete!"
  environment:
    name: production
    url: https://$DEPLOY_HOST
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  # PLACEHOLDER: Uncomment when secrets are configured
  # needs:
  #   - build
  when: manual
  allow_failure: true  # Remove when deployment is fully configured

# =============================================================================
# DEPLOYMENT SETUP INSTRUCTIONS
# =============================================================================
#
# To enable automated deployment:
#
# 1. Generate an SSH key pair for deployment:
#    ssh-keygen -t ed25519 -C "gitlab-deploy" -f gitlab-deploy-key
#
# 2. Add the PUBLIC key to your server's authorized_keys:
#    ssh-copy-id -i gitlab-deploy-key.pub deploy@your-server.com
#
# 3. In GitLab, go to Settings > CI/CD > Variables and add:
#    - DEPLOY_HOST: your-server.com (or IP address)
#    - DEPLOY_USER: deploy (or your ssh user)
#    - DEPLOY_SSH_KEY: (paste contents of gitlab-deploy-key, mark as "File" type)
#    - DEPLOY_PATH: /var/www/rcv-lunch (your app directory)
#
# 4. Ensure the server has:
#    - Node.js 18+ installed
#    - pm2 installed globally: npm install -g pm2
#    - nginx configured (see deploy/nginx/rcv-lunch.conf)
#    - Data directory created: /var/lib/rcv-lunch
#
# 5. Remove 'allow_failure: true' from deploy_production job
#
# 6. Test by pushing to main branch and manually triggering deploy
