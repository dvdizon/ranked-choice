# DR-2026-01-31-01: Periodic/Recurring Votes

**Decision ID:** DR-2026-01-31-01
**Status:** Accepted
**Date:** 2026-01-31
**Deciders:** User (David)

#### Context
Users want to create recurring votes that automatically repeat on a schedule. For example, a weekly lunch vote that creates a new voting session each week without manual intervention.

#### Source Prompt (Original Request)
> "First is a periodic survey feature: users can create a survey that repeats once every 'period'. For sake of sane defaults, once a week is the lowest duration. The user effectively creates a start time that compliments auto close."
>
> "Ultimately together: the end result is every week, a vote is created, the designated Discord server channel gets a message with links to vote and to see results. Then it auto closes and notifies the same group that the voting closed."
>
> Easter egg: "Hi Richie"

#### Clarification
> "I don't want a new survey concept. Creating vote instances are already 'surveys'."

This means recurring capability should be added directly to votes, not as a separate entity.

#### Options Considered
- **Option A: Separate "survey" entity as template**
  - Create a "survey" as a template that spawns child votes on schedule
  - Adds complexity with a new entity type
- **Option B: Recurring votes (extend existing votes)**
  - Add recurring fields directly to votes table
  - When a recurring vote closes, a new one is automatically created
  - Simpler mental model: votes can optionally be recurring
- **Option C: Manual recurring workflow**
  - API-only feature, external cron triggers vote creation
  - More flexible but requires external infrastructure

#### Decision
Implement Option B - Extend existing votes with recurring capability.

#### Rationale
- Votes ARE already the "survey" concept - no need for a separate entity
- Simpler mental model for users
- Preserves history of past voting sessions (each instance is a vote)
- Built-in scheduler (node-cron) avoids external dependencies
- Minimum period of 7 days prevents abuse/spam

#### Consequences
- Add recurring fields to `votes` table: `period_days`, `recurrence_group_id`, `integration_id`
- When a recurring vote auto-closes, scheduler creates the next vote instance
- Background job scheduler (node-cron) checks for votes to create
- Votes in the same recurrence group share settings and history
- Integration ID links to messaging platform for notifications

#### Scope
- [x] UX / product behavior
- [x] Data model
- [x] Deployment / ops (background scheduler)

#### Notes
- `recurrence_group_id` links related vote instances together
- First vote in a recurring series is the "template" for future votes
- Past vote instances remain accessible for historical reference

#### Concerns Addressed

**Concern 1: What happens when vote schema or model changes?**

When an admin needs to update recurring vote settings (options, period, integration, etc.):
- **Solution**: The latest vote in a recurrence group serves as the "template" for the next instance
- Admin can update options/settings on the current (open) vote, and changes propagate to subsequent instances
- Added `updateRecurringVoteTemplate()` function for explicit template updates
- Added `stopRecurringVoteGroup()` to disable a recurring vote
- Added `getVotesInRecurrenceGroup()` to view all historical instances for migration purposes
- No need to delete/recreate - just update the latest vote or use template update functions

**Concern 2: What are the limits on user crons in the server?**

Added protection limits to prevent server overload and abuse:
- **`MAX_RECURRING_VOTES_PER_TICK`** (default: 10) - Limits how many new vote instances can be created per scheduler tick (1 minute)
- **`MAX_ACTIVE_RECURRING_GROUPS`** (default: 100) - Limits total number of active recurring vote groups system-wide
- Configurable via environment variables
- Scheduler logs warnings when limits are reached
- Excess votes are processed in subsequent ticks (no data loss)
- Added `canCreateRecurringVote()` and `getRecurringVoteLimits()` for checking limits before creation

---
